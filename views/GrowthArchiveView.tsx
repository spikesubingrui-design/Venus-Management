/**
 * è‡ªåŠ¨åŒ–æˆé•¿æ¡£æ¡ˆè§†å›¾
 * åŸºäºæ—¥å¸¸é‡‡é›†çš„å¥åº·ã€è¿›åŒºã€è§‚å¯Ÿæ•°æ®ï¼Œä¸€é”®ç”Ÿæˆä¸ªæ€§åŒ–ã€Šæˆé•¿æ¡£æ¡ˆã€‹ä¾›å®¶é•¿æŸ¥çœ‹
 */

import React, { useState, useEffect, useMemo, useRef } from 'react';
import {
  FileText, Download, User, Heart, Brain, Palette, Users,
  TrendingUp, Calendar, Camera, Star, Award, ChevronRight,
  ChevronDown, Loader2, Eye, Share2, Printer, BookOpen,
  Activity, Utensils, Moon, Smile, Search, Filter
} from 'lucide-react';
import { User as UserType, Student, GrowthRecord, DailyHealthRecord, DevelopmentAssessment } from '../types';
import { getProfessionalObservations } from '../services/observationService';

interface GrowthArchiveViewProps {
  currentUser: UserType;
}

// äº”å¤§é¢†åŸŸé¢œè‰²
const DOMAIN_COLORS: Record<string, { bg: string; text: string; icon: any }> = {
  'å¥åº·': { bg: 'bg-rose-100', text: 'text-rose-600', icon: Heart },
  'è¯­è¨€': { bg: 'bg-blue-100', text: 'text-blue-600', icon: BookOpen },
  'ç¤¾ä¼š': { bg: 'bg-amber-100', text: 'text-amber-600', icon: Users },
  'ç§‘å­¦': { bg: 'bg-emerald-100', text: 'text-emerald-600', icon: Brain },
  'è‰ºæœ¯': { bg: 'bg-purple-100', text: 'text-purple-600', icon: Palette },
};

const GrowthArchiveView: React.FC<GrowthArchiveViewProps> = ({ currentUser }) => {
  const [students, setStudents] = useState<Student[]>([]);
  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterClass, setFilterClass] = useState('all');
  const [isGenerating, setIsGenerating] = useState(false);
  const [previewMode, setPreviewMode] = useState(false);
  const printRef = useRef<HTMLDivElement>(null);

  // å­¦ç”Ÿç›¸å…³æ•°æ®
  const [healthRecords, setHealthRecords] = useState<DailyHealthRecord[]>([]);
  const [growthRecords, setGrowthRecords] = useState<GrowthRecord[]>([]);
  const [observations, setObservations] = useState<any[]>([]);

  useEffect(() => {
    loadStudents();
  }, []);

  useEffect(() => {
    if (selectedStudent) {
      loadStudentData(selectedStudent.id);
    }
  }, [selectedStudent]);

  const loadStudents = () => {
    const saved = localStorage.getItem('kt_students_local');
    if (saved) setStudents(JSON.parse(saved));
  };

  const loadStudentData = (studentId: string) => {
    // åŠ è½½å¥åº·è®°å½•
    const healthData: DailyHealthRecord[] = [];
    const today = new Date();
    for (let i = 0; i < 30; i++) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const dayHealth = localStorage.getItem(`kt_health_${dateStr}`);
      if (dayHealth) {
        const records = JSON.parse(dayHealth);
        if (records[studentId]) {
          healthData.push(records[studentId]);
        }
      }
    }
    setHealthRecords(healthData);

    // åŠ è½½æˆé•¿è®°å½•
    const savedGrowth = localStorage.getItem('kt_growth_records');
    if (savedGrowth) {
      const all = JSON.parse(savedGrowth) as GrowthRecord[];
      setGrowthRecords(all.filter(r => r.studentId === studentId));
    }

    // åŠ è½½è§‚å¯Ÿè®°å½•
    const obs = getProfessionalObservations({ studentId });
    setObservations(obs);
  };

  // ç­çº§åˆ—è¡¨
  const classes = useMemo(() => {
    const classSet = new Set(students.map(s => s.class));
    return Array.from(classSet).sort();
  }, [students]);

  // è¿‡æ»¤å­¦ç”Ÿ
  const filteredStudents = useMemo(() => {
    let filtered = students;
    if (filterClass !== 'all') {
      filtered = filtered.filter(s => s.class === filterClass);
    }
    if (searchTerm) {
      filtered = filtered.filter(s => s.name.includes(searchTerm));
    }
    return filtered;
  }, [students, filterClass, searchTerm]);

  // è®¡ç®—å¥åº·ç»Ÿè®¡
  const healthStats = useMemo(() => {
    if (healthRecords.length === 0) return null;
    
    const avgMood = healthRecords.filter(r => r.moodStatus).length > 0
      ? healthRecords.filter(r => r.moodStatus === 'happy').length / healthRecords.filter(r => r.moodStatus).length * 100
      : 0;
    
    const avgMeal = healthRecords.filter(r => r.lunchStatus).length > 0
      ? healthRecords.filter(r => r.lunchStatus === 'all' || r.lunchStatus === 'half').length / healthRecords.filter(r => r.lunchStatus).length * 100
      : 0;
    
    const avgNap = healthRecords.filter(r => r.napStatus).length > 0
      ? healthRecords.filter(r => r.napStatus === 'good' || r.napStatus === 'normal').length / healthRecords.filter(r => r.napStatus).length * 100
      : 0;

    return { avgMood, avgMeal, avgNap, total: healthRecords.length };
  }, [healthRecords]);

  // æŒ‰é¢†åŸŸç»Ÿè®¡è§‚å¯Ÿè®°å½•
  const observationsByDomain = useMemo(() => {
    const result: Record<string, number> = {};
    observations.forEach(obs => {
      if (obs.guidelineRefs) {
        obs.guidelineRefs.forEach((ref: any) => {
          result[ref.domain] = (result[ref.domain] || 0) + 1;
        });
      }
    });
    return result;
  }, [observations]);

  // æ‰“å°/å¯¼å‡ºPDF
  const handleExportPDF = () => {
    setIsGenerating(true);
    setPreviewMode(true);
    
    setTimeout(() => {
      window.print();
      setIsGenerating(false);
    }, 500);
  };

  return (
    <div className="p-6 space-y-6 page-transition">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="flex items-center justify-between print:hidden">
        <div>
          <h1 className="text-2xl font-black text-slate-800 flex items-center gap-3">
            <div className="p-2 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-lg">
              <FileText className="w-6 h-6 text-white" />
            </div>
            æˆé•¿æ¡£æ¡ˆ
          </h1>
          <p className="text-slate-500 mt-1 text-sm">
            åŸºäºæ—¥å¸¸æ•°æ®è‡ªåŠ¨ç”Ÿæˆä¸ªæ€§åŒ–æˆé•¿æ¡£æ¡ˆï¼Œæ”¯æŒå¯¼å‡ºPDF
          </p>
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-6">
        {/* å·¦ä¾§ï¼šå­¦ç”Ÿé€‰æ‹© */}
        <div className="lg:col-span-1 print:hidden">
          <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
            <h3 className="font-bold text-slate-800 mb-4">é€‰æ‹©å­¦ç”Ÿ</h3>
            
            {/* æœç´¢å’Œç­›é€‰ */}
            <div className="space-y-3 mb-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                <input
                  type="text"
                  placeholder="æœç´¢å­¦ç”Ÿ..."
                  value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-amber-500 text-sm"
                />
              </div>
              <select
                value={filterClass}
                onChange={e => setFilterClass(e.target.value)}
                className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-amber-500 text-sm font-bold"
              >
                <option value="all">å…¨éƒ¨ç­çº§</option>
                {classes.map(cls => (
                  <option key={cls} value={cls}>{cls}</option>
                ))}
              </select>
            </div>

            {/* å­¦ç”Ÿåˆ—è¡¨ */}
            <div className="space-y-2 max-h-[60vh] overflow-y-auto">
              {filteredStudents.map(student => (
                <button
                  key={student.id}
                  onClick={() => setSelectedStudent(student)}
                  className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${
                    selectedStudent?.id === student.id
                      ? 'bg-amber-100 border-2 border-amber-500'
                      : 'bg-slate-50 hover:bg-slate-100 border-2 border-transparent'
                  }`}
                >
                  <img
                    src={student.avatar}
                    alt={student.name}
                    className="w-10 h-10 rounded-full"
                  />
                  <div className="text-left">
                    <p className="font-bold text-slate-800">{student.name}</p>
                    <p className="text-xs text-slate-500">{student.class} Â· {student.age}å²</p>
                  </div>
                  <ChevronRight className="w-4 h-4 text-slate-400 ml-auto" />
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* å³ä¾§ï¼šæ¡£æ¡ˆé¢„è§ˆ */}
        <div className="lg:col-span-2">
          {!selectedStudent ? (
            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-16 text-center">
              <FileText className="w-16 h-16 mx-auto mb-4 text-slate-300" />
              <p className="text-slate-500 font-bold">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä½å­¦ç”Ÿ</p>
              <p className="text-sm text-slate-400 mt-1">æŸ¥çœ‹å¹¶ç”Ÿæˆæˆé•¿æ¡£æ¡ˆ</p>
            </div>
          ) : (
            <div ref={printRef} className="space-y-6">
              {/* å¯¼å‡ºæŒ‰é’® */}
              <div className="flex justify-end gap-3 print:hidden">
                <button
                  onClick={() => setPreviewMode(!previewMode)}
                  className="flex items-center gap-2 px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-colors"
                >
                  <Eye className="w-4 h-4" />
                  {previewMode ? 'ç¼–è¾‘æ¨¡å¼' : 'é¢„è§ˆæ¨¡å¼'}
                </button>
                <button
                  onClick={handleExportPDF}
                  disabled={isGenerating}
                  className="flex items-center gap-2 px-4 py-2 bg-amber-600 text-white rounded-xl font-bold hover:bg-amber-700 transition-colors disabled:opacity-50"
                >
                  {isGenerating ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <Download className="w-4 h-4" />
                  )}
                  å¯¼å‡ºPDF
                </button>
              </div>

              {/* æ¡£æ¡ˆå°é¢ */}
              <div className="bg-gradient-to-br from-amber-500 via-orange-500 to-rose-500 rounded-2xl p-8 text-white shadow-xl print:rounded-none print:shadow-none">
                <div className="flex items-center gap-6">
                  <img
                    src={selectedStudent.avatar}
                    alt={selectedStudent.name}
                    className="w-24 h-24 rounded-2xl border-4 border-white/30 shadow-lg"
                  />
                  <div>
                    <h2 className="text-3xl font-black">{selectedStudent.name}</h2>
                    <p className="text-white/80 mt-1">{selectedStudent.class} Â· {selectedStudent.age}å²</p>
                    <p className="text-white/60 text-sm mt-2">
                      å…¥å›­æ—¥æœŸï¼š{selectedStudent.enrollDate}
                    </p>
                  </div>
                </div>
                <div className="mt-6 pt-6 border-t border-white/20">
                  <p className="text-2xl font-bold font-brand">æˆé•¿æ¡£æ¡ˆ</p>
                  <p className="text-white/60 text-sm">Growth Archive Â· {new Date().getFullYear()}</p>
                </div>
              </div>

              {/* åŸºæœ¬ä¿¡æ¯ */}
              <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 print:shadow-none print:border-slate-300">
                <h3 className="font-black text-slate-800 mb-4 flex items-center gap-2">
                  <User className="w-5 h-5 text-amber-600" />
                  åŸºæœ¬ä¿¡æ¯
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-slate-50 rounded-xl p-3">
                    <p className="text-xs text-slate-500">æ€§åˆ«</p>
                    <p className="font-bold text-slate-800">{selectedStudent.gender}</p>
                  </div>
                  <div className="bg-slate-50 rounded-xl p-3">
                    <p className="text-xs text-slate-500">å‡ºç”Ÿæ—¥æœŸ</p>
                    <p className="font-bold text-slate-800">{selectedStudent.birthDate}</p>
                  </div>
                  <div className="bg-slate-50 rounded-xl p-3">
                    <p className="text-xs text-slate-500">èº«é«˜</p>
                    <p className="font-bold text-slate-800">{selectedStudent.height || '-'} cm</p>
                  </div>
                  <div className="bg-slate-50 rounded-xl p-3">
                    <p className="text-xs text-slate-500">ä½“é‡</p>
                    <p className="font-bold text-slate-800">{selectedStudent.weight || '-'} kg</p>
                  </div>
                </div>
              </div>

              {/* å¥åº·æ•°æ® */}
              {healthStats && (
                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 print:shadow-none print:border-slate-300">
                  <h3 className="font-black text-slate-800 mb-4 flex items-center gap-2">
                    <Heart className="w-5 h-5 text-rose-500" />
                    è¿‘30å¤©å¥åº·æ¦‚å†µ
                  </h3>
                  <div className="grid grid-cols-3 gap-4">
                    <div className="text-center p-4 bg-amber-50 rounded-xl">
                      <Smile className="w-8 h-8 mx-auto mb-2 text-amber-500" />
                      <p className="text-2xl font-black text-amber-600">{healthStats.avgMood.toFixed(0)}%</p>
                      <p className="text-xs text-slate-500">æƒ…ç»ªæ„‰å¿«ç‡</p>
                    </div>
                    <div className="text-center p-4 bg-emerald-50 rounded-xl">
                      <Utensils className="w-8 h-8 mx-auto mb-2 text-emerald-500" />
                      <p className="text-2xl font-black text-emerald-600">{healthStats.avgMeal.toFixed(0)}%</p>
                      <p className="text-xs text-slate-500">è¿›é¤è‰¯å¥½ç‡</p>
                    </div>
                    <div className="text-center p-4 bg-blue-50 rounded-xl">
                      <Moon className="w-8 h-8 mx-auto mb-2 text-blue-500" />
                      <p className="text-2xl font-black text-blue-600">{healthStats.avgNap.toFixed(0)}%</p>
                      <p className="text-xs text-slate-500">åˆç¡è‰¯å¥½ç‡</p>
                    </div>
                  </div>
                  <p className="text-xs text-slate-400 mt-4 text-center">
                    åŸºäº {healthStats.total} æ¡å¥åº·è®°å½•ç»Ÿè®¡
                  </p>
                </div>
              )}

              {/* å‘å±•é¢†åŸŸ */}
              <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 print:shadow-none print:border-slate-300">
                <h3 className="font-black text-slate-800 mb-4 flex items-center gap-2">
                  <TrendingUp className="w-5 h-5 text-purple-500" />
                  äº”å¤§é¢†åŸŸå‘å±•
                </h3>
                <div className="grid grid-cols-5 gap-3">
                  {Object.entries(DOMAIN_COLORS).map(([domain, style]) => {
                    const count = observationsByDomain[domain] || 0;
                    return (
                      <div key={domain} className={`${style.bg} rounded-xl p-4 text-center`}>
                        <style.icon className={`w-6 h-6 mx-auto mb-2 ${style.text}`} />
                        <p className="text-xs font-bold text-slate-600">{domain}</p>
                        <p className={`text-lg font-black ${style.text}`}>{count}</p>
                        <p className="text-[10px] text-slate-400">è§‚å¯Ÿè®°å½•</p>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* ç²¾å½©è§‚å¯Ÿ */}
              {observations.length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 print:shadow-none print:border-slate-300">
                  <h3 className="font-black text-slate-800 mb-4 flex items-center gap-2">
                    <Star className="w-5 h-5 text-amber-500" />
                    ç²¾å½©è§‚å¯Ÿè®°å½•
                  </h3>
                  <div className="space-y-4">
                    {observations.slice(0, 3).map((obs, idx) => (
                      <div key={obs.id} className="bg-slate-50 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-2">
                          <h4 className="font-bold text-slate-800">{obs.title}</h4>
                          <span className="text-xs text-slate-400">
                            {new Date(obs.createdAt).toLocaleDateString()}
                          </span>
                        </div>
                        <p className="text-sm text-slate-600 line-clamp-2">{obs.behavior}</p>
                        {obs.suggestions && obs.suggestions.length > 0 && (
                          <div className="mt-2 pt-2 border-t border-slate-200">
                            <p className="text-xs text-emerald-600 font-bold">
                              ğŸ’¡ {obs.suggestions[0]}
                            </p>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* æˆé•¿è®°å½• */}
              {growthRecords.length > 0 && (
                <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 print:shadow-none print:border-slate-300">
                  <h3 className="font-black text-slate-800 mb-4 flex items-center gap-2">
                    <Award className="w-5 h-5 text-emerald-500" />
                    æˆé•¿é‡Œç¨‹ç¢‘
                  </h3>
                  <div className="space-y-3">
                    {growthRecords.slice(0, 5).map(record => (
                      <div key={record.id} className="flex items-start gap-3">
                        <div className="w-2 h-2 rounded-full bg-emerald-500 mt-2" />
                        <div>
                          <p className="font-bold text-slate-800">{record.title}</p>
                          <p className="text-sm text-slate-500">{record.content}</p>
                          <p className="text-xs text-slate-400 mt-1">{record.date}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* æ•™å¸ˆå¯„è¯­ */}
              <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white print:bg-slate-100 print:text-slate-800">
                <h3 className="font-black mb-4">ğŸ’Œ æ•™å¸ˆå¯„è¯­</h3>
                <p className="text-white/80 print:text-slate-600 leading-relaxed">
                  äº²çˆ±çš„{selectedStudent.name}å°æœ‹å‹ï¼Œåœ¨å¹¼å„¿å›­çš„æ¯ä¸€å¤©ï¼Œä½ éƒ½åœ¨å¿«ä¹åœ°æˆé•¿ã€‚
                  å¸Œæœ›ä½ ç»§ç»­ä¿æŒå¥½å¥‡å¿ƒï¼Œå‹‡äºæ¢ç´¢ï¼Œä¸å°ä¼™ä¼´ä»¬å‹å¥½ç›¸å¤„ã€‚
                  ç¥ä½ å¥åº·å¿«ä¹ï¼Œæ¯å¤©éƒ½æœ‰æ–°çš„æ”¶è·ï¼
                </p>
                <p className="text-white/50 print:text-slate-400 text-sm mt-4 text-right">
                  â€”â€” {selectedStudent.class}å…¨ä½“è€å¸ˆ
                </p>
              </div>

              {/* é¡µè„š */}
              <div className="text-center text-xs text-slate-400 py-4 print:py-8">
                <p>é‡‘æ˜Ÿæ•™è‚² Â· {selectedStudent.campus}</p>
                <p>æ¡£æ¡ˆç”Ÿæˆæ—¶é—´ï¼š{new Date().toLocaleString()}</p>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* æ‰“å°æ ·å¼ */}
      <style>{`
        @media print {
          body * { visibility: hidden; }
          .print\\:hidden { display: none !important; }
          #root { visibility: visible; }
          [data-print] { visibility: visible; }
        }
      `}</style>
    </div>
  );
};

export default GrowthArchiveView;


