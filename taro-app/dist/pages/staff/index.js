"use strict";(wx["webpackJsonp"]=wx["webpackJsonp"]||[]).push([[123],{9273:function(e,s,n){var a=n(2180),c=n(1413),l=n(3433),t=n(2688),i=n(5861),r=n(9439),o=n(7294),u=n(1515),h=n(2954),d=n.n(h),x=n(4751),m=n(1977),f=n(5686),j=n(7724),v=n(4818),g=n(5893);function p(){(0,x.Z)({title:"\u91d1\u661f\u5e7c\u513f\u56ed - \u6559\u804c\u5de5\u7ba1\u7406",path:"/pages/staff/index"});var e=(0,o.useState)([]),s=(0,r.Z)(e,2),n=s[0],a=s[1],p=(0,o.useState)(""),N=(0,r.Z)(p,2),S=N[0],G=N[1],C=(0,o.useState)(!1),Z=(0,r.Z)(C,2),b=Z[0],w=Z[1],k=(0,o.useState)({name:"",phone:"",role:"\u6559\u5e08",assignedClasses:[]}),T=(0,r.Z)(k,2),y=T[0],I=T[1],F=(0,o.useState)(!1),A=(0,r.Z)(F,2),P=A[0],_=A[1],D=(0,o.useState)(null),O=(0,r.Z)(D,2),E=O[0],J=O[1],M=(0,o.useState)([]),B=(0,r.Z)(M,2),H=B[0],K=B[1],Q=(0,o.useState)(!1),U=(0,r.Z)(Q,2),Y=U[0],q=U[1],z=(0,o.useState)(!1),L=(0,r.Z)(z,2),R=L[0],V=L[1],W=["\u6559\u5e08","\u4fdd\u80b2\u5458","\u53a8\u623f","\u4fdd\u5b89","\u56ed\u957f","\u526f\u56ed\u957f","\u8d22\u52a1"],X=j.ZE,$=(0,o.useState)(!1),ee=(0,r.Z)($,2),se=ee[0],ne=ee[1],ae=(0,o.useState)(!1),ce=(0,r.Z)(ae,2),le=ce[0],te=ce[1];(0,o.useEffect)(function(){re(),ie()},[]),(0,h.useDidShow)(function(){re(),ie()});var ie=function(){var e,s=(0,j.ts)();q((0,j.GJ)(s));var n="KITCHEN"===(null===s||void 0===s||null===(e=s.role)||void 0===e?void 0:e.toUpperCase());V(!n)},re=function(){var e=(0,i.Z)((0,t.Z)().m(function e(){var s,n,c;return(0,t.Z)().w(function(e){while(1)switch(e.p=e.n){case 0:return s=d().getStorageSync(m.I.STAFF)||[],a(s),e.p=1,e.n=2,(0,f.F1)();case 2:n=e.v,n.success&&n.data&&n.data.length>0?(a(n.data),te(!0),console.log("[Staff] \u4e91\u7aef\u6570\u636e\u5df2\u540c\u6b65:",n.data.length,"\u540d")):s.length>=20&&(te(!0),console.log("[Staff] \u4e91\u7aef\u540c\u6b65\u8df3\u8fc7\uff0c\u4f7f\u7528\u672c\u5730\u6570\u636e:",s.length,"\u540d")),e.n=4;break;case 3:e.p=3,c=e.v,console.log("[Staff] \u4e91\u7aef\u540c\u6b65\u8df3\u8fc7:",c),s.length>=20&&te(!0);case 4:return e.a(2)}},e,null,[[1,3]])}));return function(){return e.apply(this,arguments)}}(),oe=function(){var e=(0,i.Z)((0,t.Z)().m(function e(){var s,n;return(0,t.Z)().w(function(e){while(1)switch(e.p=e.n){case 0:return ne(!0),e.p=1,e.n=2,(0,m.jn)(m.I.STAFF);case 2:s=e.v,s&&s.length>0?(d().setStorageSync(m.I.STAFF,s),a(s),te(!0),d().showToast({title:"\u5df2\u540c\u6b65 ".concat(s.length," \u540d\u6559\u804c\u5de5"),icon:"success"})):d().showToast({title:"\u4e91\u7aef\u6682\u65e0\u6570\u636e",icon:"none"}),e.n=4;break;case 3:e.p=3,n=e.v,console.error("[Staff] \u540c\u6b65\u5931\u8d25:",n),d().showToast({title:"\u540c\u6b65\u5931\u8d25",icon:"none"});case 4:return e.p=4,ne(!1),e.f(4);case 5:return e.a(2)}},e,null,[[1,3,4,5]])}));return function(){return e.apply(this,arguments)}}(),ue=n.filter(function(e){return e.name.includes(S)||e.phone.includes(S)||e.role.includes(S)}),he=ue.reduce(function(e,s){var n=s.role||"\u5176\u4ed6";return e[n]||(e[n]=[]),e[n].push(s),e},{}),de=function(){var e=(0,i.Z)((0,t.Z)().m(function e(s){var n;return(0,t.Z)().w(function(e){while(1)switch(e.n){case 0:if(le){e.n=1;break}return console.warn("[Staff] \u26a0\ufe0f \u4e91\u7aef\u6570\u636e\u672a\u52a0\u8f7d\uff0c\u62d2\u7edd\u4e0a\u4f20\u4ee5\u9632\u8986\u76d6"),d().showToast({title:"\u6570\u636e\u540c\u6b65\u4e2d\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",icon:"none"}),e.a(2,!1);case 1:if(!(s.length<20)){e.n=2;break}return console.warn("[Staff] \u26a0\ufe0f \u6570\u636e\u91cf\u5f02\u5e38(".concat(s.length,"\u6761<20)\uff0c\u62d2\u7edd\u4e0a\u4f20\u4ee5\u9632\u8986\u76d6\u4e91\u7aef\u6570\u636e")),d().showToast({title:"\u6570\u636e\u5f02\u5e38\uff0c\u8bf7\u91cd\u65b0\u540c\u6b65",icon:"none"}),e.a(2,!1);case 2:return e.n=3,(0,m.Qu)(m.I.STAFF,s);case 3:return n=e.v,n.success?console.log("[Staff] \u2705 \u5b89\u5168\u4e0a\u4f20\u6210\u529f: ".concat(s.length,"\u6761")):console.error("[Staff] \u274c \u4e0a\u4f20\u5931\u8d25:",n.error),e.a(2,n.success)}},e)}));return function(s){return e.apply(this,arguments)}}(),xe=function(){if(y.name.trim())if(y.phone.trim()&&11===y.phone.length){var e={id:"t_".concat(Date.now()),name:y.name,phone:y.phone,role:y.role,assignedClasses:y.assignedClasses,class:y.assignedClasses[0]||"",hireDate:(new Date).toISOString().split("T")[0],status:"active"},s=[].concat((0,l.Z)(n),[e]);d().setStorageSync(m.I.STAFF,s),a(s),w(!1),I({name:"",phone:"",role:"\u6559\u5e08",assignedClasses:[]}),d().showToast({title:"\u6dfb\u52a0\u6210\u529f",icon:"success"}),de(s)}else d().showToast({title:"\u8bf7\u8f93\u5165\u6709\u6548\u624b\u673a\u53f7",icon:"none"});else d().showToast({title:"\u8bf7\u8f93\u5165\u59d3\u540d",icon:"none"})},me=function(e){if(Y){J(e);var s=e.assignedClasses||(e.class?[e.class]:[]);K(s),_(!0)}else d().showToast({title:"\u4ec5\u7ba1\u7406\u5458\u53ef\u5206\u914d\u73ed\u7ea7",icon:"none"})},fe=function(e){K(function(s){return s.includes(e)?s.filter(function(s){return s!==e}):[].concat((0,l.Z)(s),[e])})},je=function(){var e=(0,i.Z)((0,t.Z)().m(function e(){var s,l,i;return(0,t.Z)().w(function(e){while(1)switch(e.n){case 0:if(E){e.n=1;break}return e.a(2);case 1:s=n.map(function(e){return e.id===E.id?(0,c.Z)((0,c.Z)({},e),{},{assignedClasses:H,class:H[0]||""}):e}),d().setStorageSync(m.I.STAFF,s),a(s),_(!1),J(null),d().showToast({title:"\u5206\u914d\u6210\u529f",icon:"success"}),de(s),l=d().getStorageSync("kt_all_users")||[],i=l.findIndex(function(e){return e.phone===E.phone}),-1!==i&&(l[i].assignedClasses=H,d().setStorageSync("kt_all_users",l),(0,m.sr)().then(function(e){e.success&&console.log("[Staff] \u7528\u6237\u73ed\u7ea7\u5206\u914d\u5df2\u540c\u6b65\u5230\u4e91\u7aef")}));case 2:return e.a(2)}},e)}));return function(){return e.apply(this,arguments)}}(),ve=function(e){d().showModal({title:"\u786e\u8ba4\u5220\u9664",content:"\u786e\u5b9a\u5220\u9664 ".concat(e.name," \u5417\uff1f"),success:function(s){if(s.confirm){var c=n.filter(function(s){return s.id!==e.id});d().setStorageSync(m.I.STAFF,c),a(c),d().showToast({title:"\u5220\u9664\u6210\u529f",icon:"success"}),de(c)}}})},ge=function(e){d().makePhoneCall({phoneNumber:e})};return(0,g.jsxs)(u.G7,{className:"staff-page",children:[(0,g.jsx)(v.Z,{title:"\u6559\u804c\u5de5\u7ba1\u7406"}),(0,g.jsx)(v.p,{}),(0,g.jsxs)(u.G7,{className:"search-bar",children:[(0,g.jsxs)(u.G7,{className:"search-input",children:[(0,g.jsx)(u.xv,{className:"icon",children:"\ud83d\udd0d"}),(0,g.jsx)(u.II,{placeholder:"\u641c\u7d22\u59d3\u540d\u3001\u7535\u8bdd\u6216\u89d2\u8272",value:S,onInput:function(e){return G(e.detail.value)}})]}),(0,g.jsx)(u.G7,{className:"sync-btn ".concat(se?"syncing":""),onClick:se?void 0:oe,children:(0,g.jsx)(u.xv,{children:se?"...":"\ud83d\udd04"})}),R&&(0,g.jsx)(u.G7,{className:"add-btn",onClick:function(){return w(!0)},children:(0,g.jsx)(u.xv,{children:"+"})})]}),(0,g.jsxs)(u.G7,{className:"stats-bar",children:[(0,g.jsxs)(u.xv,{children:["\u5171 ",ue.length," \u540d\u6559\u804c\u5de5"]}),0===n.length&&(0,g.jsx)(u.xv,{className:"hint",children:"\u70b9\u51fb \ud83d\udd04 \u4ece\u4e91\u7aef\u540c\u6b65"})]}),(0,g.jsxs)(u.pf,{className:"staff-list",scrollY:!0,children:[Object.entries(he).map(function(e){var s=(0,r.Z)(e,2),n=s[0],a=s[1];return(0,g.jsxs)(u.G7,{className:"role-group",children:[(0,g.jsxs)(u.G7,{className:"role-header",children:[(0,g.jsx)(u.xv,{className:"role-name",children:n}),(0,g.jsxs)(u.xv,{className:"count",children:[a.length,"\u4eba"]})]}),a.map(function(e){var s,n;null!==(s=e.assignedClasses)&&void 0!==s&&s.length?e.assignedClasses.join("\u3001"):e.class;return(0,g.jsxs)(u.G7,{className:"staff-card",children:[(0,g.jsx)(u.G7,{className:"avatar",children:(0,g.jsx)(u.xv,{children:e.name.slice(0,1)})}),(0,g.jsxs)(u.G7,{className:"info",onClick:function(){return me(e)},children:[(0,g.jsx)(u.xv,{className:"name",children:e.name}),(0,g.jsx)(u.xv,{className:"meta",children:e.phone}),(0,g.jsx)(u.G7,{className:"class-tags",children:null!==(n=e.assignedClasses)&&void 0!==n&&n.length||e.class?(e.assignedClasses||[e.class]).filter(Boolean).map(function(e){return(0,g.jsx)(u.xv,{className:"class-tag",children:e},e)}):(0,g.jsx)(u.xv,{className:"class-tag empty",children:"\u672a\u5206\u914d\u73ed\u7ea7"})})]}),(0,g.jsxs)(u.G7,{className:"actions",children:[Y&&(0,g.jsx)(u.G7,{className:"action-btn assign",onClick:function(){return me(e)},children:(0,g.jsx)(u.xv,{children:"\ud83d\udccb"})}),(0,g.jsx)(u.G7,{className:"action-btn call",onClick:function(){return ge(e.phone)},children:(0,g.jsx)(u.xv,{children:"\ud83d\udcde"})}),R&&(0,g.jsx)(u.G7,{className:"action-btn delete",onClick:function(){return ve(e)},children:(0,g.jsx)(u.xv,{children:"\ud83d\uddd1\ufe0f"})})]})]},e.id)})]},n)}),0===ue.length&&(0,g.jsxs)(u.G7,{className:"empty",children:[(0,g.jsx)(u.xv,{className:"icon",children:"\ud83d\udc65"}),(0,g.jsx)(u.xv,{children:"\u6682\u65e0\u6559\u804c\u5de5\u6570\u636e"}),(0,g.jsx)(u.xv,{className:"hint",children:"\u8bf7\u70b9\u51fb\u9876\u90e8 \ud83d\udd04 \u4ece\u4e91\u7aef\u540c\u6b65\u6570\u636e"}),(0,g.jsx)(u.G7,{className:"sync-btn-big",onClick:oe,children:(0,g.jsx)(u.xv,{children:se?"\u540c\u6b65\u4e2d...":"\ud83d\udd04 \u7acb\u5373\u540c\u6b65"})})]}),(0,g.jsx)(u.G7,{style:{height:"100rpx"}})]}),b&&(0,g.jsx)(u.G7,{className:"modal-overlay",onClick:function(){return w(!1)},children:(0,g.jsxs)(u.G7,{className:"modal-content",onClick:function(e){return e.stopPropagation()},children:[(0,g.jsx)(u.xv,{className:"modal-title",children:"\u6dfb\u52a0\u6559\u804c\u5de5"}),(0,g.jsxs)(u.G7,{className:"form-item",children:[(0,g.jsx)(u.xv,{className:"label",children:"\u59d3\u540d *"}),(0,g.jsx)(u.II,{placeholder:"\u8bf7\u8f93\u5165\u59d3\u540d",value:y.name,onInput:function(e){return I(function(s){return(0,c.Z)((0,c.Z)({},s),{},{name:e.detail.value})})}})]}),(0,g.jsxs)(u.G7,{className:"form-item",children:[(0,g.jsx)(u.xv,{className:"label",children:"\u624b\u673a\u53f7 *"}),(0,g.jsx)(u.II,{type:"number",placeholder:"\u8bf7\u8f93\u516511\u4f4d\u624b\u673a\u53f7",value:y.phone,onInput:function(e){return I(function(s){return(0,c.Z)((0,c.Z)({},s),{},{phone:e.detail.value})})},maxlength:11})]}),(0,g.jsxs)(u.G7,{className:"form-item",children:[(0,g.jsx)(u.xv,{className:"label",children:"\u89d2\u8272"}),(0,g.jsx)(u.G7,{className:"role-options",children:W.map(function(e){return(0,g.jsx)(u.G7,{className:"role-btn ".concat(y.role===e?"active":""),onClick:function(){return I(function(s){return(0,c.Z)((0,c.Z)({},s),{},{role:e})})},children:(0,g.jsx)(u.xv,{children:e})},e)})})]}),(0,g.jsxs)(u.G7,{className:"form-item",children:[(0,g.jsx)(u.xv,{className:"label",children:"\u8d1f\u8d23\u73ed\u7ea7\uff08\u53ef\u591a\u9009\uff09"}),(0,g.jsx)(u.G7,{className:"class-options multi",children:X.map(function(e){return(0,g.jsxs)(u.G7,{className:"class-btn ".concat(y.assignedClasses.includes(e)?"active":""),onClick:function(){return I(function(s){return(0,c.Z)((0,c.Z)({},s),{},{assignedClasses:s.assignedClasses.includes(e)?s.assignedClasses.filter(function(s){return s!==e}):[].concat((0,l.Z)(s.assignedClasses),[e])})})},children:[(0,g.jsx)(u.xv,{children:e}),y.assignedClasses.includes(e)&&(0,g.jsx)(u.xv,{className:"check",children:"\u2713"})]},e)})}),y.assignedClasses.length>0&&(0,g.jsxs)(u.xv,{className:"selected-hint",children:["\u5df2\u9009\uff1a",y.assignedClasses.join("\u3001")]})]}),(0,g.jsxs)(u.G7,{className:"modal-actions",children:[(0,g.jsx)(u.G7,{className:"btn cancel",onClick:function(){return w(!1)},children:(0,g.jsx)(u.xv,{children:"\u53d6\u6d88"})}),(0,g.jsx)(u.G7,{className:"btn confirm",onClick:xe,children:(0,g.jsx)(u.xv,{children:"\u786e\u8ba4\u6dfb\u52a0"})})]})]})}),P&&E&&(0,g.jsx)(u.G7,{className:"modal-overlay",onClick:function(){return _(!1)},children:(0,g.jsxs)(u.G7,{className:"modal-content assign-modal",onClick:function(e){return e.stopPropagation()},children:[(0,g.jsx)(u.xv,{className:"modal-title",children:"\u5206\u914d\u73ed\u7ea7"}),(0,g.jsxs)(u.G7,{className:"teacher-info-header",children:[(0,g.jsx)(u.G7,{className:"avatar-large",children:(0,g.jsx)(u.xv,{children:E.name.slice(0,1)})}),(0,g.jsxs)(u.G7,{className:"teacher-detail",children:[(0,g.jsx)(u.xv,{className:"name",children:E.name}),(0,g.jsx)(u.xv,{className:"role",children:E.role})]})]}),(0,g.jsx)(u.G7,{className:"assign-hint",children:(0,g.jsx)(u.xv,{children:"\u9009\u62e9\u8be5\u6559\u5e08\u8d1f\u8d23\u7684\u73ed\u7ea7\uff08\u53ef\u591a\u9009\uff09"})}),(0,g.jsx)(u.G7,{className:"class-grid",children:X.map(function(e){return(0,g.jsxs)(u.G7,{className:"class-item ".concat(H.includes(e)?"selected":""),onClick:function(){return fe(e)},children:[(0,g.jsx)(u.xv,{className:"class-name",children:e}),H.includes(e)&&(0,g.jsx)(u.G7,{className:"check-icon",children:(0,g.jsx)(u.xv,{children:"\u2713"})})]},e)})}),H.length>0&&(0,g.jsx)(u.G7,{className:"selected-summary",children:(0,g.jsxs)(u.xv,{children:["\u5df2\u9009\u73ed\u7ea7\uff1a",H.join("\u3001")]})}),(0,g.jsxs)(u.G7,{className:"modal-actions",children:[(0,g.jsx)(u.G7,{className:"btn cancel",onClick:function(){return _(!1)},children:(0,g.jsx)(u.xv,{children:"\u53d6\u6d88"})}),(0,g.jsx)(u.G7,{className:"btn confirm",onClick:je,children:(0,g.jsx)(u.xv,{children:"\u786e\u8ba4\u5206\u914d"})})]})]})})]})}var N={navigationBarTitleText:"\u6559\u804c\u5de5\u7ba1\u7406",navigationStyle:"custom",enableShareAppMessage:!0,enableShareTimeline:!0};p.enableShareTimeline=!0,p.enableShareAppMessage=!0;Page((0,a.createPageConfig)(p,"pages/staff/index",{root:{cn:[]}},N||{}))}},function(e){var s=function(s){return e(e.s=s)};e.O(0,[107,216,592],function(){return s(9273)});e.O()}]);