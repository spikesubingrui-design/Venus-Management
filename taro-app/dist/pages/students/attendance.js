"use strict";(wx["webpackJsonp"]=wx["webpackJsonp"]||[]).push([[425],{7428:function(e,s,t){var n=t(2180),a=t(4942),c=t(2688),l=t(1413),r=t(5861),i=t(9439),o=t(7294),u=t(1515),d=t(2954),x=t.n(d),m=t(4751),h=t(5686),v=t(7724),j=t(857),N=t(4818),f=t(5893);function b(){(0,m.Z)({title:"\u91d1\u661f\u5e7c\u513f\u56ed - \u8003\u52e4\u7ba1\u7406",path:"/pages/students/attendance"});var e=(0,d.useRouter)(),s=e.params,t=s.id,n=s.name,b=s.class,p=(0,o.useState)("single"),g=(0,i.Z)(p,2),G=(g[0],g[1],(0,o.useState)((new Date).toISOString().split("T")[0])),k=(0,i.Z)(G,2),S=k[0],Z=k[1],w=(0,o.useState)([]),C=(0,i.Z)(w,2),I=C[0],y=C[1],O=(0,o.useState)({}),T=(0,i.Z)(O,2),_=T[0],D=T[1],M=(0,o.useState)("present"),E=(0,i.Z)(M,2),P=E[0],R=E[1],U=(0,o.useState)(""),A=(0,i.Z)(U,2),B=A[0],J=A[1],W=(0,o.useState)({}),q=(0,i.Z)(W,2),H=q[0],K=q[1],X=(0,o.useState)(null),Y=(0,i.Z)(X,2),z=Y[0],F=Y[1],L=(0,o.useState)(!1),Q=(0,i.Z)(L,2),V=Q[0],$=Q[1],ee=(0,o.useState)(!1),se=(0,i.Z)(ee,2),te=se[0],ne=se[1],ae=(0,o.useState)(null),ce=(0,i.Z)(ae,2),le=ce[0],re=ce[1],ie=(0,o.useState)("sick"),oe=(0,i.Z)(ie,2),ue=oe[0],de=oe[1],xe=(0,o.useState)(""),me=(0,i.Z)(xe,2),he=me[0],ve=me[1],je=(0,o.useState)(""),Ne=(0,i.Z)(je,2),fe=Ne[0],be=Ne[1],pe=["\u53d1\u70e7","\u611f\u5192","\u54b3\u55fd","\u80a0\u80c3\u4e0d\u9002","\u624b\u8db3\u53e3\u75c5","\u6c34\u75d8","\u8fc7\u654f","\u5176\u4ed6\u75be\u75c5"],ge=["\u5bb6\u4e2d\u6709\u4e8b","\u5916\u51fa\u65c5\u6e38","\u56de\u8001\u5bb6","\u770b\u533b\u751f","\u53c2\u52a0\u6d3b\u52a8","\u5bb6\u957f\u63a5\u9001\u4e0d\u4fbf","\u5176\u4ed6\u4e8b\u7531"],Ge=["\u65e0\u6545\u672a\u5230","\u8054\u7cfb\u4e0d\u4e0a\u5bb6\u957f","\u672a\u63d0\u524d\u8bf7\u5047","\u5176\u4ed6\u539f\u56e0"],ke=(0,o.useState)(!0),Se=(0,i.Z)(ke,2),Ze=Se[0],we=Se[1];(0,o.useEffect)(function(){var e,s=(0,v.ts)(),t="KITCHEN"===(null===s||void 0===s||null===(e=s.role)||void 0===e?void 0:e.toUpperCase());we(!t),Ce(),Ie()},[S]);var Ce=function(){var e=x().getStorageSync("kt_students")||[],s=(0,v.vX)(e);y(t&&n?s.filter(function(e){return!b||e.class===b}):s),console.log("[\u8003\u52e4] \u5b66\u751f\u6570\u636e\u5df2\u8fc7\u6ee4:",s.length,"\u540d (\u539f",e.length,"\u540d)")},Ie=function(){var e=(0,r.Z)((0,c.Z)().m(function e(){var s,n,a;return(0,c.Z)().w(function(e){while(1)switch(e.p=e.n){case 0:return s=x().getStorageSync("kt_attendance_".concat(S))||{},D(s),e.p=1,e.n=2,(0,h.aI)(S);case 2:n=e.v,n.success&&n.data&&Object.keys(n.data).length>0&&(s=(0,l.Z)((0,l.Z)({},s),n.data),D(s),x().setStorageSync("kt_attendance_".concat(S),s),console.log("[\u8003\u52e4] \u4e91\u7aef\u6570\u636e\u5df2\u540c\u6b65:",Object.keys(n.data).length,"\u6761")),e.n=4;break;case 3:e.p=3,a=e.v,console.log("[\u8003\u52e4] \u4e91\u7aef\u540c\u6b65\u8df3\u8fc7:",a);case 4:t&&s[t]&&(R(s[t].status),J(s[t].notes||""));case 5:return e.a(2)}},e,null,[[1,3]])}));return function(){return e.apply(this,arguments)}}(),ye=function(){var e=(0,r.Z)((0,c.Z)().m(function e(s,t){var n,a,l,r;return(0,c.Z)().w(function(e){while(1)switch(e.n){case 0:return n=x().getStorageSync("kt_attendance_".concat(S))||{},n[s]=t,x().setStorageSync("kt_attendance_".concat(S),n),D(n),e.n=1,(0,h.n)(S,s,t);case 1:a=e.v,a.success?console.log("[\u8003\u52e4] \u5df2\u540c\u6b65\u5230\u4e91\u7aef:",s):console.error("[\u8003\u52e4] \u540c\u6b65\u5931\u8d25:",a.error),["sick","leave","absent"].includes(t.status)&&(l=I.find(function(e){return e.id===s}),r={sick:"\u75c5\u5047",leave:"\u4e8b\u5047",absent:"\u7f3a\u52e4"},l&&(0,j.Sh)({studentName:l.name,className:l.class||"",status:r[t.status]||t.status,date:S,remark:t.notes||void 0}));case 2:return e.a(2)}},e)}));return function(s,t){return e.apply(this,arguments)}}(),Oe=function(){if(t){var e={studentId:t,status:P,time:(new Date).toISOString(),notes:B};ye(t,e),x().showToast({title:"\u8003\u52e4\u5df2\u8bb0\u5f55",icon:"success"}),setTimeout(function(){x().navigateBack()},1500)}},Te=function(e,s,t){if(("sick"===s||"leave"===s||"absent"===s)&&void 0===t){var n=I.find(function(s){return s.id===e});if(n){var a;re(n),de(s);var c=H[e]||(null===(a=_[e])||void 0===a?void 0:a.notes)||"",l=c.indexOf("\uff1a");return l>0?(be(c.substring(0,l)),ve(c.substring(l+1))):(be(c),ve("")),void ne(!0)}}var r={studentId:e,status:s,time:(new Date).toISOString(),notes:t||H[e]||""};ye(e,r)},_e=function(){if(le){var e=fe;he.trim()&&(e=fe?"".concat(fe,"\uff1a").concat(he):he);var s={studentId:le.id,status:ue,time:(new Date).toISOString(),notes:e};ye(le.id,s),K(function(s){return(0,l.Z)((0,l.Z)({},s),{},(0,a.Z)({},le.id,e))})}ne(!1),re(null),ve(""),be("")},De=function(){ne(!1),re(null),ve(""),be("")},Me=function(e){be(function(s){return s===e?"":e})},Ee=function(){switch(ue){case"sick":return pe;case"leave":return ge;case"absent":return Ge;default:return[]}},Pe=function(e,s){K(function(t){return(0,l.Z)((0,l.Z)({},t),{},(0,a.Z)({},e,s))});var t=_[e];t&&ye(e,(0,l.Z)((0,l.Z)({},t),{},{notes:s}))},Re=function(e){F(function(s){return s===e?null:e})},Ue=function(){x().showModal({title:"\u5168\u90e8\u51fa\u52e4",content:"\u786e\u8ba4\u5c06".concat(b||"\u5168\u90e8","\u73ed\u7ea7\u6807\u8bb0\u4e3a\u51fa\u52e4\uff1f"),success:function(e){if(e.confirm){var s=b?I.filter(function(e){return e.class===b}):I;s.forEach(function(e){Te(e.id,"present")}),x().showToast({title:"\u5df2\u5168\u90e8\u6807\u8bb0\u51fa\u52e4",icon:"success"})}}})},Ae=function(e){var s={present:"\u2705",late:"\u23f0",absent:"\u274c",sick:"\ud83c\udfe5",leave:"\ud83d\udcdd"};return s[e]||"\u23f3"},Be=function(e){var s={present:"\u51fa\u52e4",late:"\u8fdf\u5230",absent:"\u7f3a\u52e4",sick:"\u75c5\u5047",leave:"\u4e8b\u5047"};return s[e]||"\u672a\u8bb0\u5f55"},Je=I.reduce(function(e,s){var t=s.class||"\u672a\u5206\u73ed";return e[t]||(e[t]=[]),e[t].push(s),e},{}),We={total:I.length,present:Object.values(_).filter(function(e){return"present"===e.status}).length,late:Object.values(_).filter(function(e){return"late"===e.status}).length,absent:Object.values(_).filter(function(e){return"absent"===e.status}).length,sick:Object.values(_).filter(function(e){return"sick"===e.status}).length,leave:Object.values(_).filter(function(e){return"leave"===e.status}).length,unrecorded:I.length-Object.keys(_).filter(function(e){return I.some(function(s){return s.id===e})}).length},qe=function(){return I.filter(function(e){var s=_[e.id];return s&&"present"!==s.status}).map(function(e){var s,t;return(0,l.Z)((0,l.Z)({},e),{},{status:null===(s=_[e.id])||void 0===s?void 0:s.status,notes:null===(t=_[e.id])||void 0===t?void 0:t.notes})})},He=function(){$(!1),x().showToast({title:"\u8003\u52e4\u5df2\u63d0\u4ea4",icon:"success"})};return t&&n?(0,f.jsxs)(u.G7,{className:"attendance-page",children:[(0,f.jsx)(N.Z,{title:"\u8003\u52e4\u8bb0\u5f55"}),(0,f.jsx)(N.p,{}),(0,f.jsxs)(u.G7,{className:"single-mode",children:[(0,f.jsxs)(u.G7,{className:"student-info",children:[(0,f.jsx)(u.xv,{className:"name",children:decodeURIComponent(n)}),(0,f.jsx)(u.xv,{className:"class",children:decodeURIComponent(b||"")})]}),(0,f.jsx)(u.G7,{className:"date-picker",children:(0,f.jsx)(u.cW,{mode:"date",value:S,onChange:function(e){return Z(e.detail.value)},children:(0,f.jsxs)(u.G7,{className:"picker-content",children:[(0,f.jsx)(u.xv,{className:"label",children:"\u65e5\u671f"}),(0,f.jsx)(u.xv,{className:"value",children:S})]})})}),(0,f.jsxs)(u.G7,{className:"status-options",children:[(0,f.jsx)(u.xv,{className:"section-title",children:"\u8003\u52e4\u72b6\u6001"}),["present","late","absent","sick","leave"].map(function(e){return(0,f.jsxs)(u.G7,{className:"status-option ".concat(P===e?"active":""," ").concat(Ze?"":"disabled"),onClick:function(){return Ze&&R(e)},children:[(0,f.jsx)(u.xv,{className:"icon",children:Ae(e)}),(0,f.jsx)(u.xv,{className:"label",children:Be(e)}),P===e&&(0,f.jsx)(u.xv,{className:"check",children:"\u2713"})]},e)})]}),(0,f.jsxs)(u.G7,{className:"notes-section",children:[(0,f.jsx)(u.xv,{className:"section-title",children:"\u5907\u6ce8\u8bf4\u660e"}),(0,f.jsx)(u.II,{className:"notes-input",placeholder:"\u53ef\u586b\u5199\u539f\u56e0\u6216\u5907\u6ce8",value:B,onInput:function(e){return J(e.detail.value)},disabled:!Ze})]}),Ze?(0,f.jsx)(u.G7,{className:"submit-btn",onClick:Oe,children:(0,f.jsx)(u.xv,{children:"\u63d0\u4ea4\u8003\u52e4"})}):(0,f.jsx)(u.G7,{className:"submit-btn disabled",children:(0,f.jsx)(u.xv,{children:"\u4ec5\u53ef\u67e5\u770b\uff08\u65e0\u7f16\u8f91\u6743\u9650\uff09"})})]})]}):(0,f.jsxs)(u.G7,{className:"attendance-page",children:[(0,f.jsx)(N.Z,{title:"\u8003\u52e4\u8bb0\u5f55"}),(0,f.jsx)(N.p,{}),(0,f.jsxs)(u.G7,{className:"header",children:[(0,f.jsx)(u.cW,{mode:"date",value:S,onChange:function(e){return Z(e.detail.value)},children:(0,f.jsxs)(u.G7,{className:"date-display",children:[(0,f.jsx)(u.xv,{className:"date",children:S}),(0,f.jsx)(u.xv,{className:"arrow",children:"\u25bc"})]})}),Ze&&(0,f.jsxs)(u.G7,{className:"header-btns",children:[(0,f.jsx)(u.G7,{className:"quick-btn",onClick:Ue,children:(0,f.jsx)(u.xv,{children:"\u2705 \u5168\u90e8\u51fa\u52e4"})}),(0,f.jsx)(u.G7,{className:"submit-btn",onClick:function(){return $(!0)},children:(0,f.jsx)(u.xv,{children:"\u786e\u8ba4\u63d0\u4ea4"})})]})]}),(0,f.jsxs)(u.G7,{className:"stats-bar",children:[(0,f.jsxs)(u.G7,{className:"stat-item",children:[(0,f.jsx)(u.xv,{className:"number",children:We.present}),(0,f.jsx)(u.xv,{className:"label",children:"\u51fa\u52e4"})]}),(0,f.jsxs)(u.G7,{className:"stat-item",children:[(0,f.jsx)(u.xv,{className:"number yellow",children:We.late}),(0,f.jsx)(u.xv,{className:"label",children:"\u8fdf\u5230"})]}),(0,f.jsxs)(u.G7,{className:"stat-item",children:[(0,f.jsx)(u.xv,{className:"number red",children:We.absent}),(0,f.jsx)(u.xv,{className:"label",children:"\u7f3a\u52e4"})]}),(0,f.jsxs)(u.G7,{className:"stat-item",children:[(0,f.jsx)(u.xv,{className:"number orange",children:We.sick}),(0,f.jsx)(u.xv,{className:"label",children:"\u75c5\u5047"})]}),(0,f.jsxs)(u.G7,{className:"stat-item",children:[(0,f.jsx)(u.xv,{className:"number blue",children:We.leave}),(0,f.jsx)(u.xv,{className:"label",children:"\u4e8b\u5047"})]}),(0,f.jsxs)(u.G7,{className:"stat-item",children:[(0,f.jsx)(u.xv,{className:"number gray",children:We.unrecorded}),(0,f.jsx)(u.xv,{className:"label",children:"\u672a\u8bb0\u5f55"})]})]}),(0,f.jsx)(u.pf,{className:"student-list",scrollY:!0,children:Object.entries(Je).map(function(e){var s=(0,i.Z)(e,2),t=s[0],n=s[1];return(0,f.jsxs)(u.G7,{className:"class-group",children:[(0,f.jsxs)(u.G7,{className:"class-header",children:[(0,f.jsx)(u.xv,{className:"class-name",children:t}),(0,f.jsxs)(u.xv,{className:"count",children:[n.length,"\u4eba"]})]}),n.map(function(e){var s=_[e.id],t=null===s||void 0===s?void 0:s.status,n=z===e.id,a=H[e.id]||(null===s||void 0===s?void 0:s.notes)||"";return(0,f.jsxs)(u.G7,{className:"student-card",children:[(0,f.jsxs)(u.G7,{className:"student-row",children:[(0,f.jsxs)(u.G7,{className:"student-info",onClick:function(){return Re(e.id)},children:[(0,f.jsx)(u.xv,{className:"name",children:e.name}),t&&(0,f.jsxs)(u.xv,{className:"current-status ".concat(t),children:[Ae(t)," ",Be(t)]}),a&&(0,f.jsx)(u.xv,{className:"has-notes",children:"\ud83d\udcdd"})]}),(0,f.jsx)(u.G7,{className:"status-btns",children:["present","late","absent","sick","leave"].map(function(s){return(0,f.jsx)(u.G7,{className:"status-btn ".concat(s," ").concat(t===s?"active":""," ").concat(Ze?"":"disabled"),onClick:function(){return Ze&&Te(e.id,s)},children:(0,f.jsx)(u.xv,{children:Ae(s)})},s)})})]}),n&&Ze&&(0,f.jsx)(u.G7,{className:"notes-row",children:(0,f.jsx)(u.II,{className:"notes-input",placeholder:"\u586b\u5199\u5907\u6ce8\uff08\u5982\u8bf7\u5047\u539f\u56e0\u7b49\uff09",value:a,onInput:function(s){return Pe(e.id,s.detail.value)}})})]},e.id)})]},t)})}),te&&le&&(0,f.jsxs)(u.G7,{className:"notes-modal-wrapper",children:[(0,f.jsx)(u.G7,{className:"notes-modal-mask",onTouchMove:function(e){return e.stopPropagation()},onClick:De}),(0,f.jsxs)(u.G7,{className:"notes-modal-box",children:[(0,f.jsxs)(u.G7,{className:"notes-modal-header",children:[(0,f.jsx)(u.xv,{className:"notes-modal-title",children:"sick"===ue?"\ud83c\udfe5 \u75c5\u5047":"leave"===ue?"\ud83d\udcdd \u4e8b\u5047":"\u274c \u7f3a\u52e4"}),(0,f.jsxs)(u.xv,{className:"notes-modal-student",children:[le.name," \xb7 ",le.class]})]}),(0,f.jsxs)(u.G7,{className:"notes-modal-body",children:[(0,f.jsx)(u.xv,{className:"notes-section-title",children:"sick"===ue?"\u9009\u62e9\u75c5\u56e0\uff1a":"\u9009\u62e9\u539f\u56e0\uff1a"}),(0,f.jsx)(u.G7,{className:"notes-reason-list",children:Ee().map(function(e){return(0,f.jsx)(u.xv,{className:"notes-reason-item ".concat(fe===e?"active":""),onClick:function(){return Me(e)},children:e},e)})}),(0,f.jsx)(u.xv,{className:"notes-section-title",children:"\u8865\u5145\u8bf4\u660e\uff08\u9009\u586b\uff09\uff1a"}),(0,f.jsx)(u.II,{className:"notes-text-input",placeholder:"\u53ef\u586b\u5199\u8be6\u7ec6\u60c5\u51b5\u3001\u9884\u8ba1\u8fd4\u56ed\u65f6\u95f4\u7b49",value:he,onInput:function(e){return ve(e.detail.value)}})]}),(0,f.jsxs)(u.G7,{className:"notes-modal-footer",children:[(0,f.jsx)(u.xv,{className:"notes-btn-cancel",onClick:De,children:"\u53d6\u6d88"}),(0,f.jsx)(u.xv,{className:"notes-btn-confirm",onClick:_e,children:"\u786e\u8ba4"})]})]})]}),V&&(0,f.jsxs)(u.G7,{className:"confirm-modal",children:[(0,f.jsx)(u.G7,{className:"modal-overlay",onClick:function(){return $(!1)}}),(0,f.jsxs)(u.G7,{className:"modal-content",children:[(0,f.jsx)(u.G7,{className:"modal-header",children:(0,f.jsx)(u.xv,{className:"modal-title",children:"\u786e\u8ba4\u63d0\u4ea4\u8003\u52e4"})}),(0,f.jsxs)(u.G7,{className:"modal-body",children:[(0,f.jsxs)(u.xv,{className:"confirm-date",children:["\u65e5\u671f\uff1a",S]}),(0,f.jsxs)(u.G7,{className:"stats-summary",children:[(0,f.jsxs)(u.G7,{className:"stat-row",children:[(0,f.jsx)(u.xv,{className:"stat-label",children:"\u51fa\u52e4\u4eba\u6570"}),(0,f.jsxs)(u.xv,{className:"stat-value green",children:[We.present," \u4eba"]})]}),(0,f.jsxs)(u.G7,{className:"stat-row",children:[(0,f.jsx)(u.xv,{className:"stat-label",children:"\u8fdf\u5230\u4eba\u6570"}),(0,f.jsxs)(u.xv,{className:"stat-value yellow",children:[We.late," \u4eba"]})]}),(0,f.jsxs)(u.G7,{className:"stat-row",children:[(0,f.jsx)(u.xv,{className:"stat-label",children:"\u8bf7\u5047\u4eba\u6570"}),(0,f.jsxs)(u.xv,{className:"stat-value orange",children:[We.sick+We.leave," \u4eba"]})]}),(0,f.jsxs)(u.G7,{className:"stat-row",children:[(0,f.jsx)(u.xv,{className:"stat-label",children:"\u7f3a\u52e4\u4eba\u6570"}),(0,f.jsxs)(u.xv,{className:"stat-value red",children:[We.absent," \u4eba"]})]}),(0,f.jsxs)(u.G7,{className:"stat-row total",children:[(0,f.jsx)(u.xv,{className:"stat-label",children:"\u603b\u4eba\u6570"}),(0,f.jsxs)(u.xv,{className:"stat-value",children:[We.total," \u4eba"]})]})]}),qe().length>0&&(0,f.jsxs)(u.G7,{className:"non-present-list",children:[(0,f.jsx)(u.xv,{className:"list-title",children:"\u975e\u51fa\u52e4\u5b66\u751f\uff1a"}),(0,f.jsx)(u.G7,{className:"student-tags",children:qe().map(function(e){return(0,f.jsxs)(u.G7,{className:"student-tag ".concat(e.status),children:[(0,f.jsx)(u.xv,{children:e.name}),(0,f.jsx)(u.xv,{className:"tag-status",children:Be(e.status||"")})]},e.id)})})]})]}),(0,f.jsxs)(u.G7,{className:"modal-footer",children:[(0,f.jsx)(u.G7,{className:"btn cancel",onClick:function(){return $(!1)},children:(0,f.jsx)(u.xv,{children:"\u53d6\u6d88"})}),(0,f.jsx)(u.G7,{className:"btn confirm",onClick:He,children:(0,f.jsx)(u.xv,{children:"\u786e\u8ba4\u63d0\u4ea4"})})]})]})]})]})}var p={navigationBarTitleText:"\u8003\u52e4\u8bb0\u5f55",navigationStyle:"custom",enableShareAppMessage:!0,enableShareTimeline:!0};b.enableShareTimeline=!0,b.enableShareAppMessage=!0;Page((0,n.createPageConfig)(b,"pages/students/attendance",{root:{cn:[]}},p||{}))}},function(e){var s=function(s){return e(e.s=s)};e.O(0,[107,216,592],function(){return s(7428)});e.O()}]);